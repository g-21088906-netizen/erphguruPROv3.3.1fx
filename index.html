<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>eRPH Guru Pro v3.3 — Final (Cetak Profesional)</title>
<style>
:root{
  --bg:#f6f9ff; --card:#fff; --muted:#667085; --ink:#0b1b2b;
  --accent:#2563eb; --bd:#e6eef8; --radius:12px;
  --theme-blue:#2563eb; --theme-green:#059669; --theme-purple:#7c3aed; --theme-gray:#374151;
  --print-accent: var(--theme-blue);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.container{max-width:1100px;margin:18px auto;padding:16px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.title{font-size:1.2rem;font-weight:700}
.card{background:var(--card);border:1px solid var(--bd);border-radius:var(--radius);padding:12px;box-shadow:0 8px 22px rgba(10,45,90,.04);margin-bottom:12px}
.row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
label{display:flex;flex-direction:column;gap:.35rem;font-size:.95rem}
.input,select,textarea,button{font:inherit;padding:.55rem .75rem;border-radius:.6rem;border:1px solid var(--bd);background:#fff}
textarea{min-height:84px}
.button{cursor:pointer;border:1px solid var(--bd);background:transparent;border-radius:.6rem;padding:.55rem .75rem}
.button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.hint{color:var(--muted);font-size:.9rem}
.badge{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;background:#f8fafc;border:1px solid var(--bd);font-size:.86rem}
.tabs{display:flex;gap:.4rem;margin-bottom:12px}
.tab{padding:.5rem .8rem;border-radius:8px;cursor:pointer;border:1px solid transparent}
.tab.active{background:#fff;border-color:var(--bd);box-shadow:0 6px 18px rgba(10,45,90,.03)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem;align-items:start}
@media (max-width:900px){ .grid{grid-template-columns:repeat(2,1fr);} }
@media (max-width:600px){ .grid{grid-template-columns:1fr;} .header{flex-direction:column;align-items:flex-start} }

/* ensure selects and inputs never overflow */
.input, select { width:100%; max-width:100%; box-sizing:border-box; white-space:normal; }

/* debug */
.debug{font-family:ui-monospace,Menlo,Consolas;white-space:pre-wrap;background:#0b1220;color:#d7e3ff;border-radius:.6rem;padding:.7rem;border:1px solid #14213d;max-height:220px;overflow:auto}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--bd);padding:8px;text-align:left}
.small{font-size:.85rem;color:var(--muted)}

/* print area styling (A4 portrait minimal) */
.rph-print-area{display:block}
.rph-print-card{border:1px solid #e6e6e6;padding:16px;border-radius:8px;background:#fff}
.rph-print-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.rph-print-meta{font-size:0.92rem;color:var(--muted)}

/* theme classes set by JS before print */
.print-theme-blue { --print-accent: var(--theme-blue); }
.print-theme-green { --print-accent: var(--theme-green); }
.print-theme-purple { --print-accent: var(--theme-purple); }
.print-theme-gray { --print-accent: var(--theme-gray); }

/* @media print: only show print area, force visibility & static position */
@media print{
  body{background:#fff}
  .no-print{display:none!important}
  @page{size:A4 portrait; margin:14mm}
  body *:not(.rph-print-area):not(.rph-print-area *){ display:none!important; visibility:hidden!important }
  .rph-print-area{display:block !important; visibility:visible !important; position:static !important}
  .rph-print-card{box-shadow:none;border:0}
  .accent-line{height:6px;background:var(--print-accent);border-radius:4px;margin-bottom:8px}
  h1,h2,h3,div,p,span{color:#000 !important}
}

/* small toast */
.toast{position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,.4);display:none;z-index:9999}
.toast.show{display:block}

/* tidy records table actions so buttons don't stretch */
.table .no-print button{margin-right:6px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">eRPH Guru Pro v3.3</div>
      <div class="small">Import DSKP · Rekod RPH · Cetak A4 (borang rasmi)</div>
    </div>
    <div class="row no-print">
      <button id="btnAutoLoad" class="button">Muat semula ./dskp.csv</button>
      <button id="btnImportFile" class="button">Import CSV</button>
      <button id="btnPaste" class="button">Tampal CSV</button>
      <input id="fileInput" type="file" accept=".csv" style="display:none" />
    </div>
  </div>

  <div class="card">
    <div class="tabs no-print">
      <div id="tabDSKP" class="tab active">DSKP</div>
      <div id="tabRPH" class="tab">Borang RPH</div>
      <div id="tabRecords" class="tab">Rekod</div>
    </div>

    <!-- DSKP pane -->
    <div id="paneDSKP">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><strong>Import & Prapapar DSKP</strong></div>
        <div><span id="lblDSKPStatus" class="badge">Belum import</span></div>
      </div>
      <div class="hint" style="margin-top:.4rem">Kolum disaran: <code>tahun, subjek, unit, tajuk, sk, sp, tema, kemahiran</code>. Sokong koma/semikolon/tab & petikan berganda. UTF-8 disokong.</div>
      <div style="margin-top:.6rem" class="row">
        <button id="btnClearDSKP" class="button">Kosongkan DSKP</button>
        <button id="btnViewRaw" class="button">Lihat DSKP (awal)</button>
        <button id="btnCheck" class="button">Semak cepat</button>
        <div style="margin-left:auto" id="dsSummary" class="small">—</div>
      </div>
      <div id="dskpPreview" style="margin-top:10px;display:none" class="card small"><strong>Pratonton (rekod pertama)</strong><pre id="dskpPreviewBody" style="white-space:pre-wrap"></pre></div>
    </div>

    <!-- RPH pane -->
    <div id="paneRPH" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Isikan RPH</strong></div>
        <div class="row no-print">
          <button id="btnSaveRPH" class="button primary">Simpan Rekod</button>
          <button id="btnPrintRPH" class="button">Cetak RPH Sahaja</button>
          <button id="btnLoadSelected" class="button">Muat dari Rekod</button>
        </div>
      </div>

      <div style="margin-top:.8rem" class="grid">
        <label>Tarikh <input id="rphDate" class="input" type="date"></label>
        <label>Kelas <input id="rphClass" class="input" placeholder="cth: 2 Safa"></label>
        <label>Tahun <select id="selYear" class="input"></select></label>
        <label>Subjek <select id="selSubject" class="input"></select></label>

        <label>Unit <select id="selUnit" class="input"></select></label>
        <label>Tajuk <select id="selTitle" class="input"></select></label>
        <label>SK <select id="selSK" class="input"></select></label>
        <label>SP <select id="selSP" class="input"></select></label>

        <label>Masa Mula <input id="timeStart" class="input" type="time"></label>
        <label>Masa Tamat <input id="timeEnd" class="input" type="time"></label>
        <label>Jenis Pentaksiran <select id="rphAssess" class="input"><option>Formatif</option><option>Sumatif</option><option>Pemerhatian</option><option>Lisan</option><option>Bertulis</option></select></label>

        <label style="grid-column:1/-1">Objektif PdPc <textarea id="rphObj" class="input"></textarea></label>
        <label style="grid-column:1/-1">Aktiviti PdPc <textarea id="rphAkt" class="input"></textarea></label>
        <label style="grid-column:1/-1">Bahan / Sumber <textarea id="rphBBM" class="input"></textarea></label>
        <label style="grid-column:1/-1">Catatan <textarea id="rphNote" class="input"></textarea></label>

        <label style="grid-column:1/-1">Refleksi Guru <textarea id="rphReflect" class="input"></textarea></label>
        <label style="grid-column:1/-1">Pentaksiran (kesimpulan) <textarea id="rphPent" class="input"></textarea></label>
        <label style="grid-column:1/-1">Nilai Karakter <input id="rphValue" class="input" placeholder="Contoh: Disiplin, Tolong-menolong"></label>
      </div>

      <div style="margin-top:12px" class="row no-print" >
        <label style="display:flex;align-items:center;gap:8px">Tema Cetakan:
          <select id="printTheme" class="input" style="width:160px">
            <option value="blue">Biru</option>
            <option value="green">Hijau</option>
            <option value="purple">Ungu</option>
            <option value="gray">Kelabu</option>
          </select>
        </label>
        <div class="hint" style="margin-left:auto">Pilih tema warna untuk tajuk cetakan (A4).</div>
      </div>

      <!-- print preview area (used for printing) -->
      <div id="rphPrintArea" class="rph-print-area" style="margin-top:12px;display:block">
        <div class="rph-print-card" id="rphPrintCard">
          <div class="rph-print-title">
            <div>
              <h3 style="margin:0">RANCANGAN PELAKSANAAN HARIAN (RPH)</h3>
              <div id="rphMeta" class="rph-print-meta">—</div>
            </div>
            <div style="text-align:right" id="rphRightMeta" class="small">—</div>
          </div>
          <div class="accent-line" style="background:var(--print-accent)"></div>

          <div style="display:grid;grid-template-columns:160px 1fr;gap:6px">
            <div><strong>Tarikh</strong></div><div id="prDate">—</div>
            <div><strong>Kelas</strong></div><div id="prClass">—</div>
            <div><strong>Masa</strong></div><div id="prTime">—</div>
            <div><strong>Subjek / Tahun</strong></div><div id="prSubject">—</div>
            <div><strong>Unit / Tajuk</strong></div><div id="prUnit">—</div>
            <div><strong>SK</strong></div><div id="prSK">—</div>
            <div><strong>SP</strong></div><div id="prSP">—</div>
          </div>

          <hr style="margin:10px 0">
          <div><strong>Objektif PdPc</strong><div id="prObj" style="margin-top:6px">—</div></div>
          <div style="margin-top:8px"><strong>Aktiviti PdPc</strong><div id="prAkt" style="margin-top:6px">—</div></div>
          <div style="margin-top:8px"><strong>BBM / Sumber</strong><div id="prBBM" style="margin-top:6px">—</div></div>
          <div style="margin-top:8px"><strong>Refleksi Guru</strong><div id="prRef" style="margin-top:6px">—</div></div>
          <div style="margin-top:8px"><strong>Pentaksiran (kesimpulan)</strong><div id="prPent" style="margin-top:6px">—</div></div>
          <div style="margin-top:8px"><strong>Nilai Karakter</strong><div id="prVal" style="margin-top:6px">—</div></div>

          <div style="margin-top:24px;display:grid;grid-template-columns:1fr 1fr;gap:18px">
            <div style="border-top:1px solid #e6e6e6;padding-top:8px">Guru: <div id="signGuru" class="small">__________________________</div></div>
            <div style="border-top:1px solid #e6e6e6;padding-top:8px">Disemak / Disahkan: <div id="signChecker" class="small">__________________________</div></div>
          </div>

          <div style="margin-top:8px;font-size:0.85rem;color:var(--muted)">Dijana oleh eRPH Guru Pro v3.3</div>
        </div>
      </div>
    </div>

    <!-- Records pane -->
    <div id="paneRecords" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Semak Rekod RPH</strong></div>
        <div class="row no-print">
          <button id="btnExportCSV" class="button">Eksport CSV</button>
          <button id="btnBackupNow" class="button">Backup Sekarang</button>
          <button id="btnClearRecords" class="button">Padam Semua</button>
        </div>
      </div>

      <div style="margin-top:10px" class="row no-print" >
        <label>Carian Tarikh:
          <select id="filterDate" class="input" style="min-width:180px"><option value="">(Semua Tarikh)</option></select>
        </label>
      </div>

      <div style="margin-top:10px">
        <table class="table" id="tblRecords">
          <thead><tr><th>Tarikh</th><th>Masa</th><th>Subjek</th><th>Tajuk</th><th>Guru</th><th class="no-print">Tindakan</th></tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>

      <div style="margin-top:10px" class="small hint">Backup terakhir: <span id="lastBackup">—</span></div>
      <div style="margin-top:8px" class="debug" id="debugLog">— log —</div>
    </div>

  </div>
</div>

<div id="toast" class="toast">—</div>

<script>
/* eRPH Guru Pro v3.3 — Final single-file
   - robust CSV import
   - cascade selects
   - save records localStorage
   - print area fixed with small delay to ensure paint
   - filter records by date + per-record print
*/

(function(){
  const $ = id => document.getElementById(id);
  function toast(msg, t=2200){ const el=$('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), t); }
  function log(s){ const el=$('debugLog'); if(el) el.textContent = (new Date().toLocaleTimeString()) + ' ' + s + '\n' + el.textContent; console.log(s); }

  const KEY_PROFILE = 'erph_v33_profile';
  const KEY_RECORDS = 'erph_v33_records';
  const KEY_BACKUP = 'erph_v33_backup_csv';

  let DSKP_ROWS = [];
  let INDEX = { byYear: {} };

  /* CSV parsing helpers */
  function stripBOM(s){ return String(s||'').replace(/^\uFEFF/, ''); }
  function splitRow(line, delim){
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(q && line[i+1] === '"'){ cur += '"'; i++; } else q = !q;
      } else if(ch === delim && !q){ out.push(cur); cur=''; }
      else cur += ch;
    }
    out.push(cur);
    return out;
  }
  function normalizeHeader(h){
    h = String(h||'').trim().toLowerCase().replace(/\s+/g,' ');
    const map = {'tahun':'tahun','taun':'tahun','year':'tahun','subjek':'subjek','subject':'subjek','unit':'unit','tajuk':'tajuk','title':'tajuk','sk':'sk','standard kandungan':'sk','sp':'sp','standard pembelajaran':'sp','tema':'tema','kemahiran':'kemahiran'};
    return map[h] || h.replace(/[^a-z0-9]/g,'_');
  }
  function parseFlexibleCSV(text){
    text = stripBOM(text||'');
    const linesAll = text.split(/\r?\n/);
    const lines = linesAll.filter(l=>l.trim().length>0);
    if(!lines.length) return {rows:[], headers:[]};
    const head = lines[0];
    const counts = [{d:';',c:(head.match(/;/g)||[]).length},{d:'\t',c:(head.match(/\t/g)||[]).length},{d:',',c:(head.match(/,/g)||[]).length}].sort((a,b)=>b.c-a.c);
    const delim = counts[0].c>0?counts[0].d:',';
    const rawHeaders = splitRow(head, delim);
    const headers = rawHeaders.map(h=>normalizeHeader(h));
    const rows=[];
    for(let i=1;i<lines.length;i++){
      const cells = splitRow(lines[i], delim);
      if(cells.length===1 && cells[0].trim()==='') continue;
      if(cells.length > headers.length){
        const extra = cells.slice(headers.length-1).join(delim);
        cells.splice(headers.length-1, cells.length-(headers.length-1), extra);
      }
      const obj={};
      for(let j=0;j<headers.length;j++) obj[headers[j]] = (cells[j] ?? '').trim();
      rows.push(obj);
    }
    return {rows, headers};
  }

  function mapRow(o){
    return {
      tahun: String(o.tahun || o.year || '').trim(),
      subjek: (o.subjek || o.subject || '').trim(),
      unit: (o.unit || '').trim(),
      tajuk: (o.tajuk || o.title || '').trim(),
      sk: (o.sk || '').trim(),
      sp: (o.sp || '').trim(),
      tema: (o.tema || '').trim(),
      kemahiran: (o.kemahiran || '').trim(),
      _raw: o
    };
  }

  function buildIndex(rows){
    INDEX = { byYear: {} };
    rows.forEach(r=>{
      const t=r.tahun, s=r.subjek, u=r.unit, tj=r.tajuk, sk=r.sk, sp=r.sp;
      if(!t || !s) return;
      INDEX.byYear[t] = INDEX.byYear[t] || { subjects:{} };
      const Y = INDEX.byYear[t];
      Y.subjects[s] = Y.subjects[s] || { units:[], titlesByUnit:{}, skByUnit:{}, spByUnit:{} };
      const S = Y.subjects[s];
      if(u && !S.units.includes(u)) S.units.push(u);
      S.titlesByUnit[u] = S.titlesByUnit[u] || [];
      S.skByUnit[u] = S.skByUnit[u] || [];
      S.spByUnit[u] = S.spByUnit[u] || [];
      if(tj && !S.titlesByUnit[u].includes(tj)) S.titlesByUnit[u].push(tj);
      if(sk && !S.skByUnit[u].includes(sk)) S.skByUnit[u].push(sk);
      if(sp && !S.spByUnit[u].includes(sp)) S.spByUnit[u].push(sp);
    });
    Object.keys(INDEX.byYear).forEach(y=>{
      const sm = INDEX.byYear[y].subjects;
      Object.keys(sm).forEach(s=>{
        sm[s].units.sort((a,b)=>a.localeCompare(b,'ms'));
        Object.keys(sm[s].titlesByUnit).forEach(u=> sm[s].titlesByUnit[u].sort((a,b)=>a.localeCompare(b,'ms')));
        Object.keys(sm[s].skByUnit).forEach(u=> sm[s].skByUnit[u].sort((a,b)=>a.localeCompare(b,'ms')));
        Object.keys(sm[s].spByUnit).forEach(u=> sm[s].spByUnit[u].sort((a,b)=>a.localeCompare(b,'ms')));
      });
    });
  }

  function fillSelect(selId, arr){
    const sel = $(selId);
    sel.innerHTML = '';
    (arr||[]).forEach(v=>{
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      o.setAttribute('dir','auto');
      sel.appendChild(o);
    });
    if(arr && arr.length) sel.value = sel.value || arr[0];
  }

  // cascade
  function onYearChange(){
    const year = $('selYear').value;
    const Y = INDEX.byYear[year];
    if(!Y){ fillSelect('selSubject',[]); fillSelect('selUnit',[]); fillSelect('selTitle',[]); fillSelect('selSK',[]); fillSelect('selSP',[]); return; }
    const subs = Object.keys(Y.subjects).sort((a,b)=>a.localeCompare(b,'ms'));
    fillSelect('selSubject', subs);
    onSubjectChange();
  }
  function onSubjectChange(){
    const year = $('selYear').value;
    const subj = $('selSubject').value;
    const S = INDEX.byYear[year]?.subjects[subj];
    if(!S){ fillSelect('selUnit',[]); fillSelect('selTitle',[]); fillSelect('selSK',[]); fillSelect('selSP',[]); return; }
    fillSelect('selUnit', S.units || []);
    onUnitChange();
  }
  function onUnitChange(){
    const year = $('selYear').value;
    const subj = $('selSubject').value;
    const unit = $('selUnit').value;
    const S = INDEX.byYear[year]?.subjects[subj];
    if(!S){ fillSelect('selTitle',[]); fillSelect('selSK',[]); fillSelect('selSP',[]); return; }
    fillSelect('selTitle', S.titlesByUnit[unit] || []);
    fillSelect('selSK', S.skByUnit[unit] || []);
    fillSelect('selSP', S.spByUnit[unit] || []);
  }

  function handleImportedCSVText(text, label){
    try{
      const {rows, headers} = parseFlexibleCSV(text);
      if(!rows.length){ toast('Tiada baris dikesan'); return; }
      const mapped = rows.map(mapRow);
      DSKP_ROWS = mapped;
      buildIndex(mapped);
      $('lblDSKPStatus').textContent = `Dimuat: ${mapped.length} rekod • Tahun: ${Object.keys(INDEX.byYear).length}`;
      $('dskpPreview').style.display = 'block';
      $('dskpPreviewBody').textContent = JSON.stringify(mapped.slice(0,6), null, 2);
      $('dsSummary').textContent = `Rows:${mapped.length} • Years:${Object.keys(INDEX.byYear).join(',')||'—'}`;
      toast('DSKP dimuatkan');
      log(`Import ${label} — rows:${mapped.length}`);
      const years = Object.keys(INDEX.byYear).sort((a,b)=> (Number(a) && Number(b))? Number(a)-Number(b) : a.localeCompare(b,'ms'));
      fillSelect('selYear', years);
      onYearChange();
      try{ sessionStorage.setItem('erph_dskp_raw', text); }catch(e){ window.__DSKP_TMP = text; }
    }catch(e){
      console.error(e);
      toast('Import gagal — lihat console');
      log('Import error: ' + e);
    }
  }

  async function tryAutoLoad(){
    const candidates = ['./dskp.csv','./DSKP.csv'];
    for(const p of candidates){
      try{
        const res = await fetch(p, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const txt = await res.text();
        handleImportedCSVText(txt, p);
        return true;
      }catch(err){
        log('Auto-load failed ' + p + ' : ' + err);
      }
    }
    return false;
  }

  // records storage
  function loadRecords(){ try{ const s = localStorage.getItem(KEY_RECORDS); return s? JSON.parse(s): []; }catch(e){ return window.__RPH_TMP || []; } }
  function saveRecords(arr){ try{ localStorage.setItem(KEY_RECORDS, JSON.stringify(arr)); return true; }catch(e){ try{ sessionStorage.setItem(KEY_RECORDS, JSON.stringify(arr)); return true; }catch(e2){ window.__RPH_TMP = arr; return false; } } }
  function addRecord(rec){ const arr = loadRecords(); arr.unshift(rec); saveRecords(arr); toast('Rekod disimpan'); renderRecordsTable(); backupCSVNow(); }
  function deleteRecord(idx){ const arr = loadRecords(); arr.splice(idx,1); saveRecords(arr); renderRecordsTable(); updateFilterDates(); }
  function clearAllRecords(){ if(!confirm('Padam semua rekod?')) return; localStorage.removeItem(KEY_RECORDS); sessionStorage.removeItem(KEY_RECORDS); window.__RPH_TMP=null; renderRecordsTable(); updateFilterDates(); toast('Semua rekod dipadam'); }

  function buildRPHObject(){
    const prof = JSON.parse(localStorage.getItem(KEY_PROFILE)||'{}')||{};
    return {
      id: 'RPH-'+Date.now(),
      tarikh: $('rphDate').value||'',
      masa_mula: $('timeStart').value||'',
      masa_tamat: $('timeEnd').value||'',
      nama_guru: prof.name || '',
      kelas: $('rphClass').value||'',
      tahun: $('selYear').value||'',
      subjek: $('selSubject').value||'',
      unit: $('selUnit').value||'',
      tajuk: $('selTitle').value||'',
      sk: $('selSK').value||'',
      sp: $('selSP').value||'',
      objektif: $('rphObj').value||'',
      aktiviti: $('rphAkt').value||'',
      bbm: $('rphBBM').value||'',
      catatan: $('rphNote').value||'',
      refleksi: $('rphReflect').value||'',
      pentaksiran: $('rphPent').value||'',
      nilai_karakter: $('rphValue').value||'',
      saved_at: new Date().toISOString()
    };
  }

  function loadRecordToForm(rec){
    $('rphDate').value = rec.tarikh || '';
    $('timeStart').value = rec.masa_mula || '';
    $('timeEnd').value = rec.masa_tamat || '';
    $('rphClass').value = rec.kelas || '';
    $('selYear').value = rec.tahun || '';
    onYearChange();
    setTimeout(()=>{
      $('selSubject').value = rec.subjek || '';
      onSubjectChange();
      $('selUnit').value = rec.unit || '';
      onUnitChange();
      $('selTitle').value = rec.tajuk || '';
      $('selSK').value = rec.sk || '';
      $('selSP').value = rec.sp || '';
    },120);
    $('rphObj').value = rec.objektif || '';
    $('rphAkt').value = rec.aktiviti || '';
    $('rphBBM').value = rec.bbm || '';
    $('rphNote').value = rec.catatan || '';
    $('rphReflect').value = rec.refleksi || '';
    $('rphPent').value = rec.pentaksiran || '';
    $('rphValue').value = rec.nilai_karakter || '';
    renderPrintPreview();
    toast('Rekod dimuat ke borang');
  }

  // render records table with actions including per-record print and filter by date
  function renderRecordsTable(filterDate){
    const arr = loadRecords();
    const tbody = $('tblBody'); tbody.innerHTML = '';
    const filtered = (filterDate && filterDate.trim()) ? arr.filter(r=>r.tarikh===filterDate) : arr;
    filtered.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.tarikh||'—'}</td><td>${(r.masa_mula||'') + (r.masa_mula && r.masa_tamat ? ' — ' : '') + (r.masa_tamat||'')}</td><td>${r.subjek||'—'}</td><td>${r.tajuk||'—'}</td><td>${r.nama_guru||'—'}</td><td class="no-print"></td>`;
      const btnCell = tr.querySelector('td:last-child');
      const btnLoad = document.createElement('button'); btnLoad.textContent='Muat'; btnLoad.className='button'; btnLoad.style.marginRight='6px';
      btnLoad.addEventListener('click', ()=> loadRecordToForm(r));
      const btnPrint = document.createElement('button'); btnPrint.textContent='Cetak'; btnPrint.className='button'; btnPrint.style.marginRight='6px';
      btnPrint.addEventListener('click', ()=> printRecord(r));
      const btnDel = document.createElement('button'); btnDel.textContent='Padam'; btnDel.className='button';
      btnDel.addEventListener('click', ()=> { if(confirm('Padam rekod ini?')) { const all = loadRecords(); const idx = all.findIndex(x=>x.id===r.id); if(idx>=0) deleteRecord(idx); }});
      btnCell.appendChild(btnLoad); btnCell.appendChild(btnPrint); btnCell.appendChild(btnDel);
      tbody.appendChild(tr);
    });
    updateFilterDates();
    const b = localStorage.getItem(KEY_BACKUP);
    $('lastBackup').textContent = b ? new Date(Number(localStorage.getItem(KEY_BACKUP))).toLocaleString() : '—';
  }

  function updateFilterDates(){
    const arr = loadRecords();
    const dates = [...new Set(arr.map(r=>r.tarikh).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'ms'));
    const sel = $('filterDate');
    if(!sel) return;
    const current = sel.value||'';
    sel.innerHTML = '<option value="">(Semua Tarikh)</option>';
    dates.forEach(d=>{
      const o = document.createElement('option'); o.value=d; o.textContent=d; sel.appendChild(o);
    });
    sel.value = dates.includes(current) ? current : '';
  }

  function renderPrintPreview(){
    $('prDate').textContent = $('rphDate').value || '—';
    $('prClass').textContent = $('rphClass').value || '—';
    $('prTime').textContent = (($('timeStart').value||'—') + ( $('timeEnd').value ? ' — '+$('timeEnd').value : '' ));
    $('prSubject').textContent = ($('selSubject').value || '—') + ' (Tahun ' + ($('selYear').value || '—') + ')';
    $('prUnit').textContent = ($('selUnit').value || '—') + ' — ' + ($('selTitle').value || '—');
    $('prSK').textContent = $('selSK').value || '—';
    $('prSP').textContent = $('selSP').value || '—';
    $('prObj').textContent = $('rphObj').value || '—';
    $('prAkt').textContent = $('rphAkt').value || '—';
    $('prBBM').textContent = $('rphBBM').value || '—';
    $('prRef').textContent = $('rphReflect').value || '—';
    $('prPent').textContent = $('rphPent').value || '—';
    $('prVal').textContent = $('rphValue').value || '—';
    const prof = JSON.parse(localStorage.getItem(KEY_PROFILE)||'{}')||{};
    $('rphMeta').textContent = (prof.name||'') + (prof.school? ' • ' + prof.school : '') + ' • ' + new Date().toLocaleDateString('ms-MY');
    $('rphRightMeta').textContent = `Dicetak: ${new Date().toLocaleString('ms-MY')}`;
  }

  // print a single record (object r) — uses same print area but populates with record data
  function printRecord(r){
    if(!r) return;
    // fill preview with r
    $('prDate').textContent = r.tarikh || '—';
    $('prClass').textContent = r.kelas || '—';
    $('prTime').textContent = ((r.masa_mula||'—') + ( r.masa_mula && r.masa_tamat ? ' — ' : '' ) + (r.masa_tamat||''));
    $('prSubject').textContent = (r.subjek || '—') + ' (Tahun ' + (r.tahun || '—') + ')';
    $('prUnit').textContent = (r.unit || '—') + ' — ' + (r.tajuk || '—');
    $('prSK').textContent = r.sk || '—';
    $('prSP').textContent = r.sp || '—';
    $('prObj').textContent = r.objektif || '—';
    $('prAkt').textContent = r.aktiviti || '—';
    $('prBBM').textContent = r.bbm || '—';
    $('prRef').textContent = r.refleksi || '—';
    $('prPent').textContent = r.pentaksiran || '—';
    $('prVal').textContent = r.nilai_karakter || '—';
    const prof = JSON.parse(localStorage.getItem(KEY_PROFILE)||'{}')||{};
    $('rphMeta').textContent = (prof.name||'') + (prof.school? ' • ' + prof.school : '') + ' • ' + new Date().toLocaleDateString('ms-MY');
    $('rphRightMeta').textContent = `Dicetak: ${new Date().toLocaleString('ms-MY')}`;

    // set theme
    const theme = $('printTheme').value || 'blue';
    document.body.classList.remove('print-theme-blue','print-theme-green','print-theme-purple','print-theme-gray');
    document.body.classList.add(theme==='green'?'print-theme-green':theme==='purple'?'print-theme-purple':theme==='gray'?'print-theme-gray':'print-theme-blue');

    // ensure print area visible then print (with delay)
    const area = $('rphPrintArea');
    const prevDisplay = area.style.display;
    area.style.display = 'block';
    area.style.visibility = 'visible';
    area.style.position = 'static';
    setTimeout(()=>{
      try{
        window.focus();
        window.print();
      }catch(e){
        console.error(e);
      }finally{
        setTimeout(()=>{
          area.style.display = prevDisplay;
          area.style.visibility = '';
          area.style.position = '';
          document.body.classList.remove('print-theme-blue','print-theme-green','print-theme-purple','print-theme-gray');
        }, 400);
      }
    }, 450);
  }

  function exportRecordsCSV(){
    const arr = loadRecords();
    if(!arr.length){ toast('Tiada rekod untuk dieksport'); return; }
    const headers = ['Tarikh','MasaMula','MasaTamat','NamaGuru','Kelas','Tahun','Subjek','Unit','Tajuk','SK','SP','Objektif','Aktiviti','BBM','Catatan','RefleksiGuru','Pentaksiran','NilaiKarakter','SavedAt'];
    const rows = arr.map(r => headers.map(h=>{
      const mapKey = { Tarikh:'tarikh', MasaMula:'masa_mula', MasaTamat:'masa_tamat', NamaGuru:'nama_guru', Kelas:'kelas', Tahun:'tahun', Subjek:'subjek', Unit:'unit', Tajuk:'tajuk', SK:'sk', SP:'sp', Objektif:'objektif', Aktiviti:'aktiviti', BBM:'bbm', Catatan:'catatan', RefleksiGuru:'refleksi', Pentaksiran:'pentaksiran', NilaiKarakter:'nilai_karakter', SavedAt:'saved_at' }[h];
      const v = r[mapKey] ?? '';
      return `"${String(v).replace(/"/g,'""')}"`;
    }).join(','));
    const csv = headers.join(',') + '\r\n' + rows.join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'erph_records_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    toast('CSV dieksport');
  }

  function backupCSVNow(){
    try{
      const arr = loadRecords();
      if(!arr.length) return;
      const headers = ['Tarikh','MasaMula','MasaTamat','NamaGuru','Kelas','Tahun','Subjek','Unit','Tajuk','SK','SP','Objektif','Aktiviti','BBM','Catatan','RefleksiGuru','Pentaksiran','NilaiKarakter','SavedAt'];
      const rows = arr.map(r => headers.map(h=>{
        const mapKey = { Tarikh:'tarikh', MasaMula:'masa_mula', MasaTamat:'masa_tamat', NamaGuru:'nama_guru', Kelas:'kelas', Tahun:'tahun', Subjek:'subjek', Unit:'unit', Tajuk:'tajuk', SK:'sk', SP:'sp', Objektif:'objektif', Aktiviti:'aktiviti', BBM:'bbm', Catatan:'catatan', RefleksiGuru:'refleksi', Pentaksiran:'pentaksiran', NilaiKarakter:'nilai_karakter', SavedAt:'saved_at' }[h];
        return `"${String(r[mapKey]||'').replace(/"/g,'""')}"`;
      }).join(','));
      const csv = headers.join(',') + '\r\n' + rows.join('\r\n');
      try{ localStorage.setItem(KEY_BACKUP+'_csv', csv); }catch(e){ try{ sessionStorage.setItem(KEY_BACKUP+'_csv', csv); }catch(e2){ window.__ERPH_BACKUP = csv; } }
      localStorage.setItem(KEY_BACKUP, String(Date.now()));
      $('lastBackup').textContent = new Date(Number(localStorage.getItem(KEY_BACKUP))).toLocaleString();
      toast('Backup disimpan');
    }catch(e){ console.warn(e); }
  }

  // print function for current form RPH (main print button)
  function printRPHOnly(){
    renderPrintPreview();
    const area = $('rphPrintArea');
    const prevDisplay = area.style.display;
    area.style.display = 'block';
    area.style.visibility = 'visible';
    area.style.position = 'static';

    const theme = $('printTheme').value || 'blue';
    document.body.classList.remove('print-theme-blue','print-theme-green','print-theme-purple','print-theme-gray');
    document.body.classList.add(theme==='green'?'print-theme-green':theme==='purple'?'print-theme-purple':theme==='gray'?'print-theme-gray':'print-theme-blue');

    setTimeout(()=>{
      try{
        window.focus();
        window.print();
      }catch(e){
        console.error(e);
      }finally{
        setTimeout(()=>{
          area.style.display = prevDisplay;
          area.style.visibility = '';
          area.style.position = '';
          document.body.classList.remove('print-theme-blue','print-theme-green','print-theme-purple','print-theme-gray');
        }, 400);
      }
    }, 550);
  }

  // UI: tab switching
  function showTab(tab){
    ['tabDSKP','tabRPH','tabRecords'].forEach(id=> $(id).classList.remove('active'));
    ['paneDSKP','paneRPH','paneRecords'].forEach(id=> $(id).style.display='none');
    if(tab==='dskp'){ $('tabDSKP').classList.add('active'); $('paneDSKP').style.display='block'; }
    if(tab==='rph'){ $('tabRPH').classList.add('active'); $('paneRPH').style.display='block'; }
    if(tab==='records'){ $('tabRecords').classList.add('active'); $('paneRecords').style.display='block'; renderRecordsTable(); }
  }

  // init bindings
  document.addEventListener('DOMContentLoaded', ()=> {
    // tabs
    $('tabDSKP').addEventListener('click', ()=> showTab('dskp'));
    $('tabRPH').addEventListener('click', ()=> showTab('rph'));
    $('tabRecords').addEventListener('click', ()=> showTab('records'));

    // imports
    $('btnImportFile').addEventListener('click', ()=> $('fileInput').click());
    $('fileInput').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> handleImportedCSVText(String(reader.result||''), f.name);
      reader.readAsText(f, 'utf-8');
    });
    $('btnPaste').addEventListener('click', ()=> {
      const t = prompt('Tampal CSV di sini (Cancel untuk batal):');
      if(t) handleImportedCSVText(String(t), 'paste');
    });
    $('btnAutoLoad').addEventListener('click', ()=> {
      tryAutoLoad().then(ok=> { if(!ok) toast('Auto-load gagal — guna Import Manual'); });
    });
    $('btnClearDSKP').addEventListener('click', ()=> {
      if(!confirm('Kosongkan DSKP dimuatkan?')) return;
      DSKP_ROWS=[]; INDEX={byYear:{}}; $('lblDSKPStatus').textContent='Belum import'; $('dskpPreview').style.display='none'; $('dsSummary').textContent='—'; toast('DSKP dikosongkan');
    });
    $('btnViewRaw').addEventListener('click', ()=> {
      if(!DSKP_ROWS.length){ toast('Tiada DSKP dimuat'); return; }
      alert(JSON.stringify(DSKP_ROWS.slice(0,80), null, 2));
    });
    $('btnCheck').addEventListener('click', ()=> {
      $('dsSummary').textContent = `Rows: ${DSKP_ROWS.length} • Years: ${Object.keys(INDEX.byYear).join(',')||'—'}`;
      toast('Semak selesai');
    });

    // cascade binds
    $('selYear').addEventListener('change', onYearChange);
    $('selSubject').addEventListener('change', onSubjectChange);
    $('selUnit').addEventListener('change', onUnitChange);
    ['selTitle','selSK','selSP'].forEach(id=> $(id).addEventListener('change', ()=> renderPrintPreview()));

    // RPH actions
    $('btnSaveRPH').addEventListener('click', ()=>{
      let prof = JSON.parse(localStorage.getItem(KEY_PROFILE) || 'null') || {};
      if(!prof.name){
        const nm = prompt('Isikan nama guru (untuk simpan rekod):');
        if(!nm){ toast('Nama guru diperlukan'); return; }
        prof.name = nm; localStorage.setItem(KEY_PROFILE, JSON.stringify(prof));
      }
      const rec = buildRPHObject();
      if(!rec.tarikh || !rec.subjek){ toast('Sila isi tarikh & subjek'); return; }
      rec.nama_guru = prof.name;
      addRecord(rec);
    });
    $('btnPrintRPH').addEventListener('click', ()=> printRPHOnly());
    $('btnLoadSelected').addEventListener('click', ()=> { showTab('records'); toast('Pilih rekod dan tekan "Muat"'); });

    // records actions
    $('btnExportCSV').addEventListener('click', ()=> exportRecordsCSV());
    $('btnBackupNow').addEventListener('click', ()=> backupCSVNow());
    $('btnClearRecords').addEventListener('click', ()=> clearAllRecords());

    // filter change
    $('filterDate').addEventListener('change', ()=> renderRecordsTable($('filterDate').value));

    // form input preview updates
    ['rphDate','rphClass','timeStart','timeEnd','rphObj','rphAkt','rphBBM','rphNote','rphReflect','rphPent','rphValue','selYear','selSubject','selUnit','selTitle','selSK','selSP'].forEach(id=>{
      $(id).addEventListener('input', ()=> renderPrintPreview());
      $(id).addEventListener('change', ()=> renderPrintPreview());
    });

    // try auto-load on start
    tryAutoLoad().then(ok=>{
      if(!ok) log('No auto dskp.csv found — import manually');
      renderPrintPreview();
    });

    // records
    renderRecordsTable();
    updateFilterDates();
  });

  // auto backup
  window.addEventListener('beforeunload', ()=> { try{ backupCSVNow(); }catch(e){} });

})(); // IIFE
</script>
</body>
</html>
